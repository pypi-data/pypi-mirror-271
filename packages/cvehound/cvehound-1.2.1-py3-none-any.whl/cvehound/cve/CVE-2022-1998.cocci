/// Files: fs/notify/fanotify/fanotify_user.c
/// Fix: ee12595147ac1fbfb5bcb23837e26dd58d94b15d
/// Fixes: f644bc449b37cc32d3ce7b36a88073873aa21bd5

virtual detect

@err@
identifier fd, f, event;
symbol out_close_fd;
position p;
@@

copy_event_to_user(..., struct fanotify_event *event, ...)
{
	...
*	if (fanotify_is_perm_event(event->mask))
*		FANOTIFY_PERM(event)->fd = fd;
*
*	if (f)
*		fd_install@p(fd, f);
	... when any
*	goto out_close_fd;
	... when any
out_close_fd:
	...
*	put_unused_fd(fd)
	...
}

@script:python depends on detect@
p << err.p;
@@

coccilib.report.print_report(p[0], 'ERROR: CVE-2022-1998')
