/// Files: drivers/media/usb/em28xx/em28xx-cards.c
/// Fix: c08eadca1bdfa099e20a32f8fa4b52b2f672236d
/// Fixes: 47677e51e2a4040c204d7971a5103592600185b1

virtual detect

@err_dev_next@
identifier dev;
position p;
@@

em28xx_usb_probe(...)
{
	...
	if (dev->board.has_dual_ts && em28xx_duplicate_dev(dev) == 0) {
		...
*		kref_init@p(&dev->dev_next->ref);
	}
	...
}

@err_dev@
identifier dev;
position p;
@@

em28xx_usb_probe(...)
{
	...
*	kref_init@p(&dev->ref);
	request_modules(dev);
	...
}

@script:python depends on detect@
p << err_dev.p;
@@

coccilib.report.print_report(p[0], 'ERROR: CVE-2022-3239')

@script:python depends on detect@
p << err_dev_next.p;
@@

coccilib.report.print_report(p[0], 'ERROR: CVE-2022-3239')
