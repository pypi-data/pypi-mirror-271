/// Files: net/packet/af_packet.c
/// Fix: 15fe076edea787807a7cdc168df832544b58eba6
/// Fixes: 30f7ea1c2b5f5fb7462c5ae44fe2e40cb2d6a474

virtual detect

@err@
identifier need_rehook, sk, po;
position p;
@@

packet_do_bind(struct sock *sk, ...)
{
	...
	if (need_rehook) {
		if (po->running) {
			rcu_read_unlock();
			... when != po->num = 0;
			    when != WRITE_ONCE(po->num, 0);
*			__unregister_prot_hook@p(sk, ...);
			...
		}
		...
	}
	...
}

@script:python depends on detect@
p << err.p;
@@

coccilib.report.print_report(p[0], 'ERROR: CVE-2018-18559')
