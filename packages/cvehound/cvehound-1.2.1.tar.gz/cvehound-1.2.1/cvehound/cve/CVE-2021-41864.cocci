/// Files: kernel/bpf/stackmap.c
/// Fix: 30e29a9a2bc6a4888335a6ede968b75cd329657a
/// Fixes: 557c0c6e7df8e14a46bd7560d193fa5bbc00a858

virtual detect

@err exists@
identifier smap, elem_size;
position p;
@@

prealloc_elems_and_freelist(struct bpf_stack_map *smap)
{
	...
*	u32 elem_size =@p sizeof(struct stack_map_bucket) + smap->map.value_size;
	...
*	elem_size*smap->map.max_entries
	...
}

@script:python depends on detect@
p << err.p;
@@

coccilib.report.print_report(p[0], 'ERROR: CVE-2021-41864')
