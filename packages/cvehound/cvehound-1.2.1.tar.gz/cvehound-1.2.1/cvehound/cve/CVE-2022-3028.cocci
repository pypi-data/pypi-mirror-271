/// Files: net/key/af_key.c include/net/netns/xfrm.h
/// Fix: ba953a9d89a00c078b85f4b190bc1dde66fe16b5
/// Fixes: 283bc9f35bbbcb0e9ab4e6d2427da7f9f710d52d
/// Version: 1.0.7

virtual detect

@lock@
typedef spinlock_t;
@@

struct netns_xfrm {
	...
*	spinlock_t xfrm_state_lock;
	...
};

@err depends on lock@
identifier sk, skb;
symbol pfkey_mutex;
position p;
@@

pfkey_register(struct sock *sk, struct sk_buff *skb, ...)
{
	... when != mutex_lock(&pfkey_mutex);
*	xfrm_probe_algs@p();
	...
}

@script:python depends on detect@
p << err.p;
@@

coccilib.report.print_report(p[0], 'ERROR: CVE-2022-3028')
